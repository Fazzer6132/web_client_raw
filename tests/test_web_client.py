from web_client import WebClient
import responses
import pytest

url = "https://www.openexchangerates.org"
app_id = "f4ac58b20ec54e19b5ac494b52c7c05c"


@responses.activate
@pytest.mark.parametrize("key", ["UAH", "GBP", "JPY", "ILS", "AED", "AFN"])
def test_web_client(key):
    valid_answer = {
        "disclaimer": "Usage subject to terms: https://openexchangerates.org/terms",
        "license": "https://openexchangerates.org/license",
        "timestamp": 1654264800,
        "base": "USD",
        "rates": {
            "AED": 3.673,
            "AFN": 88.499983,
            "ALL": 112.25,
            "AMD": 446.563646,
            "ANG": 1.802823,
            "AOA": 426.46885,
            "ARS": 120.622741,
            "AUD": 1.381317,
            "AWG": 1.8,
            "AZN": 1.7,
            "BAM": 1.821639,
            "BBD": 2,
            "BDT": 89.067368,
            "BGN": 1.822265,
            "BHD": 0.376976,
            "BIF": 2027,
            "BMD": 1,
            "BND": 1.374294,
            "BOB": 6.887466,
            "BRL": 4.7823,
            "BSD": 1,
            "BTC": 0.000033732663,
            "BTN": 77.644471,
            "BWP": 11.979994,
            "BYN": 3.377869,
            "BZD": 2.01642,
            "CAD": 1.256003,
            "CDF": 2002.5,
            "CHF": 0.960395,
            "CLF": 0.02937,
            "CLP": 810.4,
            "CNH": 6.64393,
            "CNY": 6.6603,
            "COP": 3770.5,
            "CRC": 683.03004,
            "CUC": 1,
            "CUP": 25.75,
            "CVE": 103.18,
            "CZK": 23.002,
            "DJF": 178.089246,
            "DKK": 6.922614,
            "DOP": 55.15,
            "DZD": 145.380983,
            "EGP": 18.6362,
            "ERN": 15.000001,
            "ETB": 51.6,
            "EUR": 0.930484,
            "FJD": 2.1368,
            "FKP": 0.79568,
            "GBP": 0.79568,
            "GEL": 2.98,
            "GGP": 0.79568,
            "GHS": 7.825,
            "GIP": 0.79568,
            "GMD": 54.1,
            "GNF": 8837.5,
            "GTQ": 7.697552,
            "GYD": 209.290603,
            "HKD": 7.84432,
            "HNL": 24.56,
            "HRK": 6.9981,
            "HTG": 112.327693,
            "HUF": 366.807456,
            "IDR": 14446.896457,
            "ILS": 3.33179,
            "IMP": 0.79568,
            "INR": 77.603656,
            "IQD": 1459.5,
            "IRR": 42300,
            "ISK": 128.35,
            "JEP": 0.79568,
            "JMD": 153.930023,
            "JOD": 0.709,
            "JPY": 130.50292857,
            "KES": 116.85,
            "KGS": 79.522481,
            "KHR": 4061,
            "KMF": 458.749854,
            "KPW": 900,
            "KRW": 1248.457917,
            "KWD": 0.306158,
            "KYD": 0.833555,
            "KZT": 434.912154,
            "LAK": 13390.901035,
            "LBP": 1517.620785,
            "LKR": 360.617401,
            "LRD": 151.999978,
            "LSL": 15.49,
            "LYD": 4.77,
            "MAD": 9.84,
            "MDL": 18.989828,
            "MGA": 3995,
            "MKD": 57.431141,
            "MMK": 1852.099678,
            "MNT": 3105.3554,
            "MOP": 8.082033,
            "MRU": 36.51,
            "MUR": 43.795281,
            "MVR": 15.435,
            "MWK": 816.25,
            "MXN": 19.50203,
            "MYR": 4.391,
            "MZN": 63.850001,
            "NAD": 15.49,
            "NGN": 415.05,
            "NIO": 35.82,
            "NOK": 9.424325,
            "NPR": 124.227573,
            "NZD": 1.530218,
            "OMR": 0.385028,
            "PAB": 1,
            "PEN": 3.705,
            "PGK": 3.525,
            "PHP": 52.858004,
            "PKR": 197.6,
            "PLN": 4.272352,
            "PYG": 6850.093983,
            "QAR": 3.641,
            "RON": 4.5998,
            "RSD": 109.279814,
            "RUB": 62.756995,
            "RWF": 1028.5,
            "SAR": 3.750297,
            "SBD": 8.116969,
            "SCR": 12.851327,
            "SDG": 455.5,
            "SEK": 9.735298,
            "SGD": 1.373795,
            "SHP": 0.79568,
            "SLL": 12887.2,
            "SOS": 583,
            "SRD": 21.22,
            "SSP": 130.26,
            "STD": 22994,
            "STN": 23.15,
            "SVC": 8.753033,
            "SYP": 2512.53,
            "SZL": 15.49,
            "THB": 34.3225,
            "TJS": 11.306259,
            "TMT": 3.51,
            "TND": 3.02,
            "TOP": 2.299263,
            "TRY": 16.531774,
            "TTD": 6.780823,
            "TWD": 29.3275,
            "TZS": 2328,
            "UAH": 29.3696,
            "UGX": 3739.850326,
            "USD": 1,
            "UYU": 40.062773,
            "UZS": 11015,
            "VES": 5.11435,
            "VND": 23192,
            "VUV": 114.629832,
            "WST": 2.612952,
            "XAF": 610.357241,
            "XAG": 0.04488733,
            "XAU": 0.00053661,
            "XCD": 2.70255,
            "XDR": 0.724318,
            "XOF": 610.357241,
            "XPD": 0.00049433,
            "XPF": 111.036231,
            "XPT": 0.00096806,
            "YER": 250.249937,
            "ZAR": 15.49977,
            "ZMW": 17.063351,
            "ZWL": 322
        }
    }
    responses.add(method=responses.GET,
                  url="https://www.openexchangerates.org/api/latest.json?app_id=f4ac58b20ec54e19b5ac494b52c7c05c",
                  json=valid_answer, status=200)

    webclient = WebClient(url, app_id)
    res = webclient.request_rate(key)
    assert res == valid_answer["rates"][key]

@responses.activate
@pytest.mark.parametrize("key", ["UAH"])
def test_web_client_w_error(key):
    valid_answer_w_error = {
        "error": "true",
        "status": 401,
        "message": "invalid_app_id",
        "description": "Invalid App ID provided. Please sign up at https://openexchangerates.org/signup, or contact "
                       "support@openexchangerates.org. "
    }
    responses.add(method=responses.GET,
                  url="https://www.openexchangerates.org/api/latest.json?app_id=123",
                  json=valid_answer_w_error, status=401)
    with pytest.raises(KeyError):
        webclient = WebClient(url, "123")
        webclient.request_rate(key)
